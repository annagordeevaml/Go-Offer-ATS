# Исправление ошибки доступа при сохранении кандидатов

## Проблема
При попытке сохранить кандидата возникает ошибка:
- `403 (Forbidden)`
- `permission denied for table users`

## Причина
RLS политики пытались напрямую обращаться к таблице `auth.users`, к которой у обычных пользователей нет доступа.

## Решение

### Шаг 1: Обновите SQL скрипт в Supabase

1. Откройте Supabase Dashboard → SQL Editor
2. Откройте файл `create_candidates_table.sql` в вашем проекте
3. **ВАЖНО**: Замените `'admin@go-offer.us'` на email вашего админ-пользователя (в 3 местах: в функции `is_admin_user()` и в комментариях)
4. Скопируйте весь обновленный SQL скрипт
5. Вставьте его в SQL Editor в Supabase
6. Нажмите "Run" для выполнения

### Шаг 2: Проверьте, что вы залогинены как админ

1. Убедитесь, что вы залогинены с email, который указан в SQL скрипте как админ
2. Если нет - залогиньтесь с правильным email

### Шаг 3: Перезапустите приложение

1. Остановите dev-сервер (Ctrl+C)
2. Запустите снова: `npm run dev`
3. Обновите страницу в браузере (F5 или Cmd+R)

### Шаг 4: Попробуйте снова добавить кандидата

Теперь должно работать без ошибок доступа.

## Что изменилось

1. **Создана функция `is_admin_user()`**: Эта функция безопасно получает email пользователя из `auth.users` с правами `SECURITY DEFINER`, что позволяет обойти ограничения RLS.

2. **Обновлены RLS политики**: Теперь они используют функцию `is_admin_user()` вместо прямого обращения к `auth.users`.

3. **Упрощена проверка**: Политики стали проще и надежнее.

## Если ошибка все еще возникает

1. Проверьте, что функция `is_admin_user()` создана в Supabase:
   ```sql
   SELECT * FROM pg_proc WHERE proname = 'is_admin_user';
   ```

2. Проверьте, что email в функции совпадает с email вашего админ-пользователя:
   ```sql
   SELECT auth.uid(), (SELECT email FROM auth.users WHERE id = auth.uid());
   ```

3. Убедитесь, что RLS политики созданы:
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'candidates';
   ```


